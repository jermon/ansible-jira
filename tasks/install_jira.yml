---

- name: Download Exec Jira
  get_url: 
    url: "{{ jira_download_url }}"
    dest: /tmp/{{ jira_exec }}
    owner: root
    group: root
    mode: 0777  
  become: yes
 
- name: Copy Jira Template
  template: 
    src: response.varfile.j2
    dest: /tmp/response.varfile
 
- name: Install Jira
  command: /tmp/{{ jira_exec }} -q -varfile /tmp/response.varfile
  args:
    creates: "{{ jira_home }}"
  become: yes

- name: Dependencies for JIRA
  yum: name={{ item }} state=installed
  with_items:
   - lsb
   
#- name: Copy the service script
#  template: 
#    src: jira.service.j2 
#    dest: /usr/lib/systemd/system/jira.service
#  when: ansible_os_family == "RedHat" and ansible_lsb.major_release|int == 7
#  become: yes
  
#- name: Remove the init.d script
#  file:
#    path: /etc/init.d/jira
#    state: absent
#  when: ansible_os_family == "RedHat" and ansible_lsb.major_release|int == 7
#  become: yes
  
#- name: Copy the init.d script
#  template: 
#    src: jira.j2
#    dest: /etc/init.d/jira
#    owner: root
#    group: root
#    mode: 0755
#  when: ansible_os_family == "RedHat" and ansible_lsb.major_release|int == 6
#  sudo: yes

- name: Copy Jira dbconfig File
  template: 
    src: dbconfig_pg.xml.j2
    dest: "{{ jira_home }}/dbconfig.xml"
    owner: "{{jira_user}}"
    group: "{{jira_group}}"
    mode: 0664
  become: yes


- name: Remove .exe and .bat files from linux install
  file:
    path: "{{ jira_install }}/jira/bin/{{ item }}" 
    state: absent
  with_items:
    - catalina.bat    
    - permgen.bat         
    - setenv.bat      
    - stop-jira.bat
    - config.bat      
    - permgenservice.bat  
    - shutdown.bat    
    - tool-wrapper.bat
    - configtest.bat  
    - service.bat         
    - start-jira.bat  
    - version.bat
    - digest.bat
    - setclasspath.bat    
    - startup.bat
    - tomcat7.exe
    - tomcat7.exe.x64
    - tomcat7w.exe

- name: Remove licenses dir
  file:
    path: "{{ jira_install }}/licenses" 
    state: absent

- name: chown and touch files
  file:
    path: "{{ jira_install }}" 
    owner: "{{ jira_user }}" 
    group: "{{ jira_group }}" 
    recurse: yes
    state: directory
    
- name: Stop jira
  command: "{{ jira_install }}/bin/stop-jira.sh"
  args:
    removes: "{{ jira_install }}/work/catalina.pid"
  become: yes
   
- name: Start jira
  command: "{{ jira_install }}/bin/start-jira.sh"
  args:
    chdir: "{{ jira_install }}"
    creates: "{{ jira_install }}/work/catalina.pid" 
  become: yes
    

